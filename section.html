<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Section â€” Royal Sherwani</title>
  <style>
    :root{--accent1:#007bff;--accent2:#00c6ff;--green:#28a745;--red:#dc3545}
    body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#f3f7ff,#ffffff);color:#222}
    .hidden{display:none!important}

    /* header */
    .header{background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:16px;color:#fff;display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .back{position:absolute;left:12px;color:#fff;text-decoration:none;font-weight:600}
    .title{font-weight:700;font-size:20px}
    .logout{position:absolute;right:12px;background:var(--red);color:#fff;border:none;padding:8px 12px;border-radius:14px;cursor:pointer}

    /* toolbar */
    .toolbar{display:flex;gap:10px;justify-content:center;padding:14px;flex-wrap:wrap}
    .toolbar input,.toolbar select{padding:10px;border-radius:10px;border:1px solid #e6e9ef;width:220px}
    .container{max-width:980px;margin:0 auto;padding:12px}

    /* bill list */
    #billList{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:720px){ #billList{grid-template-columns:repeat(2,1fr)} }

    .bill-card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(10,20,40,0.04);display:flex;justify-content:space-between;align-items:center;gap:12px}
    .bill-left{font-weight:700}
    .bill-meta{color:#667788;font-size:13px;margin-top:6px}

    /* actions layout: mobile -> column (buttons spaced), desktop -> row */
    .bill-actions{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
    .bill-actions button{min-width:84px;padding:8px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:600}
    .btn-view{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
    .btn-move{background:linear-gradient(90deg,#33b5ff,#1aa1ff);color:#fff}
    .btn-copy{background:#333;color:#fff}
    @media(min-width:520px){
      .bill-actions{flex-direction:row;align-items:center}
    }

    /* Modal base */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:120}
    .modal.show{display:flex}
    .modal-box{background:#fff;border-radius:12px;padding:14px;width:92%;max-width:880px;max-height:88vh;overflow:auto;box-shadow:0 20px 70px rgba(4,10,30,0.12)}
    .modal-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .opt-btn{flex:1;padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .opt-booked{background:#efefef;color:#222}
    .opt-ready{background:linear-gradient(90deg,#ffb347,#ff7b7b);color:#fff}
    .opt-delivered{background:linear-gradient(90deg,#6a11cb,#2575fc);color:#fff}
    .opt-delete{background:#dc3545;color:#fff}

    .input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:8px}

    .grid-photos{display:grid;grid-template-columns:repeat(auto-fill,120px);gap:12px;padding:8px}
    .grid-photos img{width:120px;height:120px;object-fit:cover;border-radius:8px}
    .photo-wrap{position:relative}

    .download-btn{position:absolute;right:6px;top:6px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;padding:6px;cursor:pointer}

    .create-order{display:block;width:100%;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--green),#5fe08b);color:#fff;font-weight:700;margin-top:12px;cursor:pointer}

    .muted{color:#667788;font-size:13px}
    .small{font-size:13px}

    /* merged preview helper (not shown in modal, but ensures consistent appearance) */
    .merged-preview{width:100%;max-width:100%;display:block;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.06)}
  </style>
</head>
<body>
  <header class="header">
    <a href="index.html" class="back">â¬… Back</a>
    <div class="title" id="sectionTitle">Section</div>
    <button id="logoutBtn" class="logout">Logout</button>
  </header>

  <div class="toolbar">
    <input id="searchInput" placeholder="Search bills (bill no / date)"/>
    <select id="sortSelect">
      <option value="date-asc">Date Asc</option>
      <option value="date-desc">Date Desc</option>
      <option value="bill-asc">Bill No Asc</option>
      <option value="bill-desc">Bill No Desc</option>
    </select>
  </div>

  <main class="container">
    <ul id="billList"></ul>
  </main>

  <!-- Move Options Modal -->
  <div id="moveModal" class="modal">
    <div class="modal-box" style="max-width:420px">
      <h3 style="margin:0 0 8px">Move Bill â€” Select Action</h3>
      <div style="font-size:13px;color:#444">Choose one of the options below to move/delete or deliver</div>
      <div class="modal-row" style="margin-top:12px">
        <button id="moveBooked" class="opt-btn opt-booked">Booked</button>
        <button id="moveReady" class="opt-btn opt-ready">Ready</button>
      </div>
      <div class="modal-row">
        <button id="moveDelivered" class="opt-btn opt-delivered">Delivered</button>
        <button id="moveDelete" class="opt-btn opt-delete">Delete</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="closeMoveModal" class="input" style="background:#eee;border-radius:8px">Close</button>
      </div>
    </div>
  </div>

  <!-- Delivered Payment Modal -->
  <div id="paymentModal" class="modal">
    <div class="modal-box" style="max-width:420px">
      <h3 style="margin:0 0 8px">Enter Payment & Delivered Date</h3>
      <input id="payAmount" type="number" class="input" placeholder="Amount (numeric)"/>
      <select id="payMethod" class="input"><option>Cash</option><option>UPI</option><option>Card</option></select>
      <input id="payDate" type="date" class="input"/>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="submitPayment" class="opt-btn" style="background:linear-gradient(90deg,#6a11cb,#2575fc);color:#fff">Submit</button>
        <button id="cancelPayment" class="opt-btn" style="background:#eee">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Photo Viewer Modal -->
  <div id="photoModal" class="modal">
    <div class="modal-box">
      <h3 id="photoTitle">Bill Photos</h3>

      <div style="font-weight:600;margin-top:6px">Main Photos</div>
      <div id="mainGrid" class="grid-photos"></div>

      <div style="font-weight:600;margin-top:8px">Measurement Photos</div>
      <div id="measGrid" class="grid-photos"></div>

      <button id="createOrderBtn" class="create-order">ðŸ›  Create Order (Merge)</button>
      <button id="closePhotoModal" style="margin-top:10px;background:#dc3545;color:#fff;padding:10px;border:none;width:100%;border-radius:8px">Close</button>
    </div>
  </div>

  <!-- Share panel for delivered info -->
  <div id="shareModal" class="modal">
    <div class="modal-box" style="max-width:420px">
      <h3>Delivered â€” Details</h3>
      <pre id="shareText" class="muted"></pre>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="copyShare" class="opt-btn" style="background:linear-gradient(90deg,#6a11cb,#2575fc);color:#fff">Copy</button>
        <button id="closeShare" class="opt-btn" style="background:#eee">Close</button>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js"

  const SUPABASE_URL = "https://zrbetimapyxqzzxyxbrg.supabase.co"
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyYmV0aW1hcHl4cXp6eHl4YnJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTgwODYsImV4cCI6MjA3MjM3NDA4Nn0.XzBz0JUuJS9EUbuoWEt7P75jl8dfl3q2KfJAFXnTq4E"
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

  let currentUser = null
  let billsCache = []
  let selectedBillId = null
  let selectedBillObj = null

  // DOM refs
  const sectionTitle = document.getElementById("sectionTitle")
  const billList = document.getElementById("billList")
  const searchInput = document.getElementById("searchInput")
  const sortSelect = document.getElementById("sortSelect")
  const logoutBtn = document.getElementById("logoutBtn")

  const moveModal = document.getElementById("moveModal")
  const moveBooked = document.getElementById("moveBooked")
  const moveReady = document.getElementById("moveReady")
  const moveDelivered = document.getElementById("moveDelivered")
  const moveDelete = document.getElementById("moveDelete")
  const closeMoveModal = document.getElementById("closeMoveModal")

  const paymentModal = document.getElementById("paymentModal")
  const payAmount = document.getElementById("payAmount")
  const payMethod = document.getElementById("payMethod")
  const payDate = document.getElementById("payDate")
  const submitPayment = document.getElementById("submitPayment")
  const cancelPayment = document.getElementById("cancelPayment")

  const photoModal = document.getElementById("photoModal")
  const mainGrid = document.getElementById("mainGrid")
  const measGrid = document.getElementById("measGrid")
  const createOrderBtn = document.getElementById("createOrderBtn")
  const closePhotoModal = document.getElementById("closePhotoModal")

  const shareModal = document.getElementById("shareModal")
  const shareText = document.getElementById("shareText")
  const copyShare = document.getElementById("copyShare")
  const closeShare = document.getElementById("closeShare")

  // restore session
  try {
    const saved = localStorage.getItem("supabaseUser")
    if (!saved) { window.location.href = "index.html"; throw new Error("no session") }
    currentUser = JSON.parse(saved)
    console.log("Section: restored user:", currentUser.email)
  } catch (err) { console.error("session restore", err) }

  // URL params
  const urlParams = new URLSearchParams(window.location.search)
  const typeParam = urlParams.get("type") || "Booked"
  const focusIdParam = urlParams.get("focus")
  const actionParam = urlParams.get("action")

  sectionTitle.textContent = typeParam

  // load bills for this section
  async function loadBills(){
    try {
      const { data, error } = await supabase.from("bills").select("*").eq("user_id", currentUser.id).eq("status", typeParam)
      if (error) { console.error("loadBills err:", error); billsCache = []; renderBills(); return }
      billsCache = data || []
      console.log("Loaded bills:", billsCache.length)
      renderBills()
    } catch (err) { console.error("loadBills exception", err) }
  }

  function renderBills(){
    const q = (searchInput.value || "").toLowerCase().trim()
    let arr = billsCache.slice()
    if (q) {
      arr = arr.filter(b => {
        const bn = (b.bill_no||"").toString()
        const dd = (b.delivery_date||"").toLowerCase()
        const deld = (b.delivered_date||"").toLowerCase()
        return bn.includes(q) || dd.includes(q) || deld.includes(q)
      })
    }
    const s = sortSelect.value
    arr.sort((a,b)=>{
      if (s==="bill-asc") return (a.bill_no||0)-(b.bill_no||0)
      if (s==="bill-desc") return (b.bill_no||0)-(a.bill_no||0)
      const da = (a.status==="Delivered"?a.delivered_date:a.delivery_date)||""
      const db = (b.status==="Delivered"?b.delivered_date:b.delivery_date)||""
      if (s==="date-asc") return new Date(da)-new Date(db)
      if (s==="date-desc") return new Date(db)-new Date(da)
      return 0
    })

    billList.innerHTML = ""
    arr.forEach(b => {
      const li = document.createElement("li"); li.className = "bill-card"
      const dateText = b.status==="Delivered" ? (`Delivered: ${b.delivered_date||"-"}`) : (`Delivery: ${b.delivery_date||"-"}`)
      // actions: View, Move, (if Delivered show Copy)
      const actionsDiv = document.createElement("div"); actionsDiv.className = "bill-actions"
      const viewBtn = document.createElement("button"); viewBtn.textContent = "View"; viewBtn.className="btn-view"; viewBtn.onclick = ()=> openPhotoViewer(b.id)
      const moveBtn = document.createElement("button"); moveBtn.textContent = "Move"; moveBtn.className="btn-move"; moveBtn.onclick = ()=> openMove(b.id)
      actionsDiv.appendChild(viewBtn); actionsDiv.appendChild(moveBtn)
      if (typeParam === "Delivered") {
        const copyBtn = document.createElement("button"); copyBtn.textContent = "Copy"; copyBtn.className = "btn-copy"; copyBtn.onclick = ()=> copyDeliveredDetails(b)
        actionsDiv.appendChild(copyBtn)
      }
      li.innerHTML = `<div>
                        <div class="bill-left">#${b.bill_no}</div>
                        <div class="bill-meta">${dateText}</div>
                      </div>`
      li.appendChild(actionsDiv)
      billList.appendChild(li)
    })
  }

  searchInput.addEventListener("input", renderBills)
  sortSelect.addEventListener("change", renderBills)

  // View photos
  async function openPhotoViewer(billId){
    try {
      const { data: bill, error } = await supabase.from("bills").select("*").eq("id", billId).single()
      if (error || !bill) { alert("Cannot load bill"); console.error(error); return }
      selectedBillId = billId; selectedBillObj = bill
      document.getElementById("photoTitle").textContent = `Bill #${bill.bill_no} â€” Photos`
      // parse arrays - support both array or text[]
      const mainImgs = Array.isArray(bill.main_images) ? bill.main_images : (bill.main_images ? JSON.parse(bill.main_images) : [])
      const measImgs = Array.isArray(bill.measurement_images) ? bill.measurement_images : (bill.measurement_images ? JSON.parse(bill.measurement_images) : [])
      mainGrid.innerHTML = ""; measGrid.innerHTML = ""
      if (mainImgs.length===0) mainGrid.innerHTML = "<div class='muted'>No main images uploaded</div>"
      if (measImgs.length===0) measGrid.innerHTML = "<div class='muted'>No measurement images uploaded</div>"
      mainImgs.forEach(url=>{
        const wrap = document.createElement("div"); wrap.className="photo-wrap"
        wrap.innerHTML = `<img src="${url}" alt="main"/><button class="download-btn" onclick="downloadImage('${url}')">â¬‡</button><div style="text-align:center;margin-top:6px"><input type="radio" name="mainSelect" value="${url}"/> Select</div>`
        mainGrid.appendChild(wrap)
      })
      measImgs.forEach(url=>{
        const wrap = document.createElement("div"); wrap.className="photo-wrap"
        wrap.innerHTML = `<img src="${url}" alt="meas"/><button class="download-btn" onclick="downloadImage('${url}')">â¬‡</button><div style="text-align:center;margin-top:6px"><input type="radio" name="measSelect" value="${url}"/> Select</div>`
        measGrid.appendChild(wrap)
      })
      photoModal.classList.add("show"); photoModal.classList.remove("hidden")
    } catch (err) { console.error("openPhotoViewer err", err) }
  }

  window.openPhotoViewer = openPhotoViewer
  window.downloadImage = (url) => {
    try {
      const a = document.createElement("a"); a.href = url; a.download = "image"; document.body.appendChild(a); a.click(); a.remove()
    } catch (err) { console.error("download error", err) }
  }

  // ---------- Merge helpers ----------
  function loadImg(url){
    return new Promise((res,rej)=>{
      const i = new Image()
      i.crossOrigin = "anonymous"
      i.onload = ()=> res(i)
      i.onerror = (e)=> { console.error("img load error", url, e); rej(new Error("Image load failed")) }
      i.src = url
    })
  }

  // draw cover: scale and crop center to fill target rect
  function drawImageCover(ctx, img, x, y, w, h){
    const iw = img.width, ih = img.height
    const scale = Math.max(w/iw, h/ih)
    const sw = w/scale, sh = h/scale
    const sx = Math.max(0, (iw - sw)/2)
    const sy = Math.max(0, (ih - sh)/2)
    ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h)
  }

  // draw contain: fit whole image inside rect, center it, leave background visible
  function drawImageContain(ctx, img, x, y, w, h, bg="#ffffff"){
    const iw = img.width, ih = img.height
    const scale = Math.min(w/iw, h/ih)
    const dw = Math.round(iw * scale), dh = Math.round(ih * scale)
    const dx = x + Math.round((w - dw)/2), dy = y + Math.round((h - dh)/2)
    // optional background
    if (bg) {
      ctx.fillStyle = bg
      ctx.fillRect(x, y, w, h)
    }
    ctx.drawImage(img, 0, 0, iw, ih, dx, dy, dw, dh)
  }

  function formatDDMMYYYY(dStr){
    if (!dStr) return ""
    const d = new Date(dStr)
    if (isNaN(d)) return dStr
    const dd = String(d.getDate()).padStart(2,"0")
    const mm = String(d.getMonth()+1).padStart(2,"0")
    const yyyy = d.getFullYear()
    return `${dd}-${mm}-${yyyy}`
  }

  // Create order (merge) - improved: 40% measurement (left, contain), 60% main (right, cover)
  createOrderBtn.addEventListener("click", async ()=>{
    try {
      const mainUrl = document.querySelector('input[name="mainSelect"]:checked')?.value
      const measUrl = document.querySelector('input[name="measSelect"]:checked')?.value
      if (!mainUrl || !measUrl) return alert("Select one main and one measurement photo")

      // load images
      const [mainImg, measImg] = await Promise.all([ loadImg(mainUrl), loadImg(measUrl) ])

      // canvas size (you can tweak)
      const canvasW = 1600
      const canvasH = 1000
      const canvas = document.createElement("canvas")
      canvas.width = canvasW; canvas.height = canvasH
      const ctx = canvas.getContext("2d")

      // white background
      ctx.fillStyle = "#ffffff"
      ctx.fillRect(0,0,canvasW,canvasH)

      // left area 40% measurement, right area 60% main
      const leftW = Math.round(canvasW * 0.40)
      const rightW = canvasW - leftW

      // draw measurement on left (contain - do NOT crop)
      drawImageContain(ctx, measImg, 0, 0, leftW, canvasH, "#ffffff")

      // draw main on right (cover - center crop)
      drawImageCover(ctx, mainImg, leftW, 0, rightW, canvasH)

      // OVERLAYS styling function: white fill + black stroke
      function strokeFillText(text, x, y, font, align="center"){
        ctx.font = font
        ctx.textAlign = align
        ctx.lineWidth = Math.max(3, Math.round(canvasW/800)) // scale stroke with canvas size
        ctx.strokeStyle = "#000"
        ctx.fillStyle = "#fff"
        ctx.lineJoin = "round"
        ctx.miterLimit = 2
        ctx.strokeText(text, x, y)
        ctx.fillText(text, x, y)
      }

      // 1) Site title center-top
      strokeFillText("Royal Sherwani", canvasW/2, 60, "bold 36px sans-serif", "center")

      // 2) Delivery date (formatted dd-mm-yyyy) -> show above measurement (left) area, centered in that area
      const dateText = formatDDMMYYYY(selectedBillObj?.delivery_date || selectedBillObj?.delivered_date || "")
      if (dateText) {
        strokeFillText(dateText, leftW/2, 60, "bold 28px sans-serif", "center")
      }

      // 3) User id top-right (small)
      const uid = currentUser?.email || currentUser?.id || ""
      if (uid) {
        // right padding 12
        ctx.font = "bold 20px sans-serif"
        ctx.textAlign = "right"
        ctx.lineWidth = 5
        ctx.strokeStyle = "#000"
        ctx.fillStyle = "#fff"
        const ux = canvasW - 12, uy = 38
        ctx.strokeText(uid, ux, uy)
        ctx.fillText(uid, ux, uy)
      }

      // 4) Bill number (numeric only, no '#') - big, centered vertically on right/main area
      const billNumber = (selectedBillObj?.bill_no || "").toString().replace(/[^0-9]/g,"") || (selectedBillObj?.bill_no||"")
      if (billNumber) {
        // choose a large font and place roughly center of right area
        const centerX = leftW + Math.round(rightW/2)
        const centerY = Math.round(canvasH/2) + 40
        // text size scale: make it large but fit
        // try big font first; if text width > area, reduce
        let fontSize = 140
        ctx.font = `bold ${fontSize}px sans-serif`
        let metrics = ctx.measureText(billNumber)
        while ((metrics.width > rightW * 0.9) && fontSize > 40) {
          fontSize -= 10
          ctx.font = `bold ${fontSize}px sans-serif`
          metrics = ctx.measureText(billNumber)
        }
        strokeFillText(billNumber, centerX, centerY, `bold ${fontSize}px sans-serif`, "center")
      }

      // download merged image
      const now = new Date()
      const pad = n => String(n).padStart(2,"0")
      const dd = pad(now.getDate()), mm = pad(now.getMonth()+1), yyyy = now.getFullYear()
      const hh = pad(now.getHours()), min = pad(now.getMinutes()), ss = pad(now.getSeconds())
      const billno = selectedBillObj?.bill_no || "bill"
      const filename = `${billno}-${dd}-${mm}-${yyyy}-${hh}-${min}-${ss}.png`

      const link = document.createElement("a")
      link.download = filename
      link.href = canvas.toDataURL("image/png")
      document.body.appendChild(link)
      link.click()
      link.remove()
      alert("Merged image downloaded: " + filename)

    } catch (err) {
      console.error("createOrder err", err)
      alert("Error creating merged image: " + (err && err.message ? err.message : "unknown"))
    }
  })

  closePhotoModal.addEventListener("click", ()=> { photoModal.classList.remove("show"); photoModal.classList.add("hidden") })

  // ---------- MOVE flow (open modal with options) ----------
  window.openMove = async (id) => {
    selectedBillId = id
    // show modal
    moveModal.classList.add("show"); moveModal.classList.remove("hidden")
  }

  closeMoveModal.addEventListener("click", ()=> { moveModal.classList.remove("show"); moveModal.classList.add("hidden") })

  // Booked
  moveBooked.addEventListener("click", async ()=>{
    moveModal.classList.remove("show"); moveModal.classList.add("hidden")
    await updateStatus(selectedBillId, "Booked")
  })
  // Ready
  moveReady.addEventListener("click", async ()=>{
    moveModal.classList.remove("show"); moveModal.classList.add("hidden")
    await updateStatus(selectedBillId, "Ready")
  })
  // Delete
  moveDelete.addEventListener("click", async ()=>{
    if (!confirm("Delete this bill?")) return
    moveModal.classList.remove("show"); moveModal.classList.add("hidden")
    const { error } = await supabase.from("bills").delete().eq("id", selectedBillId)
    if (error) { alert("Delete failed: "+error.message); console.error(error); return }
    alert("Deleted")
    await loadBills()
  })
  // Delivered -> open payment modal
  moveDelivered.addEventListener("click", async ()=>{
    moveModal.classList.remove("show"); moveModal.classList.add("hidden")
    payDate.value = new Date().toISOString().slice(0,10)
    paymentModal.classList.add("show"); paymentModal.classList.remove("hidden")
  })

  cancelPayment.addEventListener("click", ()=> {
    paymentModal.classList.remove("show"); paymentModal.classList.add("hidden")
  })

  // submit payment -> update DB + copy share text
  submitPayment.addEventListener("click", async ()=>{
    const amt = payAmount.value.trim()
    const method = payMethod.value
    const ddate = payDate.value || new Date().toISOString().slice(0,10)
    if (!amt) return alert("Enter amount")
    try {
      const { error } = await supabase.from("bills").update({ status:"Delivered", amount: amt, method, delivered_date: ddate }).eq("id", selectedBillId)
      if (error) { alert("Update failed: "+error.message); console.error(error); return }
      paymentModal.classList.remove("show"); paymentModal.classList.add("hidden")
      await loadBills()
      // fetch updated bill to copy details
      const { data } = await supabase.from("bills").select("*").eq("id", selectedBillId).single()
      const text = `Bill No: ${data.bill_no}\nAmount: ${data.amount}\nPayment: ${data.method}\nDelivered Date: ${data.delivered_date}`
      shareText.textContent = text
      try { await navigator.clipboard.writeText(text); alert("Delivered and copied to clipboard") } catch { /* fallback show modal */ }
      shareModal.classList.add("show"); shareModal.classList.remove("hidden")
    } catch (err) { console.error("submitPayment err", err); alert("Error updating payment") }
  })

  copyShare.addEventListener("click", async ()=>{
    try { await navigator.clipboard.writeText(shareText.textContent); alert("Copied to clipboard") } catch { alert("Copy failed") }
  })
  closeShare.addEventListener("click", ()=> { shareModal.classList.remove("show"); shareModal.classList.add("hidden") })

  async function updateStatus(id, status){
    try {
      const { error } = await supabase.from("bills").update({ status }).eq("id", id)
      if (error) { alert("Update failed: " + error.message); console.error(error); return }
      await loadBills()
    } catch (err) { console.error("updateStatus err", err) }
  }

  // initial load
  loadBills()
</script>
</body>
</html>