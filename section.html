<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Section — Royal Sherwani</title>
<style>
  :root{
    --bg:#f6f9ff; --card:#fff; --muted:#6b7280;
    --accent1:#0ea5ff; --accent2:#7c3aed;
    --green:#10b981; --orange:#f59e0b; --red:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#0f172a}

  /* header */
  .header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;position:sticky;top:0;z-index:50;box-shadow:0 6px 24px rgba(7,12,28,0.12)}
  .back{color:#fff;text-decoration:none;font-weight:700}
  .brand{font-weight:800;font-size:18px}
  .logout{background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.14);padding:8px 12px;border-radius:10px;color:#fff;cursor:pointer}

  /* toolbar */
  .toolbar{max-width:1100px;margin:14px auto;padding:0 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .searchBox{display:flex;align-items:center;gap:8px;flex:1;max-width:640px}
  .searchInput{flex:1;padding:10px 14px;border-radius:12px;border:1px solid rgba(15,23,42,0.06);background:#fff;box-shadow:0 8px 24px rgba(2,6,23,0.04)}
  .controls{display:flex;gap:10px;align-items:center}
  .sortSelect{padding:10px 12px;border-radius:12px;border:1px solid rgba(15,23,42,0.06);background:#fff}

  /* container & list */
  .container{max-width:1100px;margin:0 auto;padding:8px 14px 80px}
  #statusNote{color:var(--muted);text-align:center;margin-bottom:8px}
  #billList{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:900px){ #billList{grid-template-columns:repeat(2,1fr)} }

  .card{background:var(--card);padding:14px;border-radius:12px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;box-shadow:0 10px 30px rgba(10,20,40,0.04)}
  .leftCol{display:flex;flex-direction:column;gap:6px;min-width:0}
  .billRow{display:flex;align-items:center;gap:10px}
  .billNo{font-weight:800;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .statusShort{display:inline-flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:8px;color:#fff;font-weight:800;margin-left:8px;cursor:pointer;user-select:none}
  .short-LT{background:var(--red)}
  .short-OD{background:var(--orange)}
  .short-RD{background:var(--green)}
  .short-NO{background:#eef2f6;color:#0f172a}

  .meta{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .actions{display:flex;gap:8px;flex-direction:row;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btnView{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
  .btnMove{background:linear-gradient(90deg,#33b5ff,#1aa1ff);color:#fff}
  .btnCopy{background:#0f172a;color:#fff}

  /* modals */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:200}
  .modal.show{display:flex}
  .modalBox{width:94%;max-width:820px;background:#fff;padding:14px;border-radius:12px;box-shadow:0 30px 90px rgba(3,7,18,0.12);color:#0f172a;max-height:88vh;overflow:auto}
  .modalHeader{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .modalBody{margin-top:12px}
  .modalRow{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .input, textarea, select{padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:#fff}
  textarea{min-height:120px;resize:vertical}
  .modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .saveBtn{background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
  .closeBtn{background:#eef2f6;padding:10px 12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);cursor:pointer}

  /* photo grid */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,120px);gap:12px}
  .grid img{width:120px;height:120px;object-fit:cover;border-radius:8px}
  .photo-wrap{position:relative}
  .download-btn{position:absolute;right:6px;top:6px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;padding:6px;cursor:pointer}

  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  @media(max-width:520px){ .actions{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>

  <header class="header">
    <div style="display:flex;align-items:center;gap:12px">
      <a class="back" href="index.html">← Back</a>
      <div class="brand">Royal Sherwani</div>
    </div>
    <div>
      <button id="logoutBtn" class="logout">Logout</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="searchBox">
      <input id="searchInput" class="searchInput" placeholder="Search bills (bill no / date)" />
    </div>
    <div class="controls">
      <select id="sortSelect" class="sortSelect">
        <option value="date-desc">Newest</option>
        <option value="date-asc">Oldest</option>
        <option value="bill-desc">Bill # Desc</option>
        <option value="bill-asc">Bill # Asc</option>
      </select>
    </div>
  </div>

  <main class="container">
    <div id="statusNote" class="muted">Loading bills…</div>
    <ul id="billList"></ul>
  </main>

  <!-- STATUS modal -->
  <div id="statusModal" class="modal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalHeader">
        <div style="font-weight:800" id="statusHeading">Bill Status</div>
        <div>
          <button id="saveStatusBtn" class="saveBtn">Save</button>
          <button id="closeStatusBtn" class="closeBtn">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="modalRow">
          <label style="font-weight:700">Action</label>
          <select id="actionSelect" class="input">
            <option>No Action</option>
            <option>Alter</option>
            <option>Order</option>
            <option>Ready</option>
          </select>
        </div>
        <div class="modalRow">
          <label style="font-weight:700">Notes</label>
          <textarea id="notesInput" placeholder="Type notes..."></textarea>
          <div id="autoSaveMsg" class="small">Notes autosave after pause.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MOVE modal -->
  <div id="moveModal" class="modal">
    <div class="modalBox" style="max-width:460px">
      <h3 style="margin:0 0 8px">Move Bill — Select</h3>
      <div style="font-size:13px;color:#444">Choose destination</div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="moveToBooked" class="saveBtn" style="flex:1;background:#f3f4f6;color:#111">Booked</button>
        <button id="moveToReady" class="saveBtn" style="flex:1;background:linear-gradient(90deg,#ffb347,#ff7b7b)">Ready</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="moveToDelivered" class="saveBtn" style="flex:1;background:linear-gradient(90deg,#6a11cb,#2575fc)">Delivered</button>
        <button id="moveToDelete" class="closeBtn" style="flex:1;background:#fff;border:1px solid #f87171;color:#b91c1c">Delete</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="closeMove" class="closeBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- PAYMENT modal for Delivered -->
  <div id="paymentModal" class="modal">
    <div class="modalBox" style="max-width:420px">
      <h3 style="margin:0 0 8px">Enter Payment & Delivered Date</h3>
      <input id="payAmount" type="number" class="input" placeholder="Amount (numeric)"/>
      <select id="payMethod" class="input"><option>Cash</option><option>UPI</option><option>Card</option></select>
      <input id="payDate" type="date" class="input"/>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="submitPayment" class="saveBtn" style="flex:1">Submit</button>
        <button id="cancelPayment" class="closeBtn" style="flex:1">Cancel</button>
      </div>
    </div>
  </div>

  <!-- PHOTO modal -->
  <div id="photoModal" class="modal">
    <div class="modalBox">
      <div class="modalHeader">
        <div style="font-weight:800" id="photoTitle">Bill Photos</div>
        <div><button id="closePhoto" class="closeBtn">Close</button></div>
      </div>
      <div class="modalBody">
        <div style="font-weight:700;margin-top:10px">Main Photos</div>
        <div id="mainGrid" class="grid"></div>

        <div style="font-weight:700;margin-top:12px">Measurement Photos</div>
        <div id="measGrid" class="grid"></div>

        <div style="margin-top:12px">
          <button id="createMergeBtn" class="saveBtn" style="width:100%">Create Merged Image (use selected images)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SHARE panel -->
  <div id="shareModal" class="modal">
    <div class="modalBox" style="max-width:420px">
      <h3>Delivered — Details</h3>
      <pre id="shareText" class="muted"></pre>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="copyShare" class="saveBtn" style="flex:1">Copy</button>
        <button id="closeShare" class="closeBtn" style="flex:1">Close</button>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  // ====== SUPABASE CONFIG - replace with your keys if needed ======
  const SUPABASE_URL = "https://zrbetimapyxqzzxyxbrg.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyYmV0aW1hcHl4cXp6eHl4YnJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTgwODYsImV4cCI6MjA3MjM3NDA4Nn0.XzBz0JUuJS9EUbuoWEt7P75jl8dfl3q2KfJAFXnTq4E";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // DOM
  const billList = document.getElementById('billList');
  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');
  const statusNote = document.getElementById('statusNote');
  const logoutBtn = document.getElementById('logoutBtn');

  const statusModal = document.getElementById('statusModal');
  const statusHeading = document.getElementById('statusHeading');
  const actionSelect = document.getElementById('actionSelect');
  const notesInput = document.getElementById('notesInput');
  const saveStatusBtn = document.getElementById('saveStatusBtn');
  const closeStatusBtn = document.getElementById('closeStatusBtn');
  const autoSaveMsg = document.getElementById('autoSaveMsg');

  const moveModal = document.getElementById('moveModal');
  const moveToBooked = document.getElementById('moveToBooked');
  const moveToReady = document.getElementById('moveToReady');
  const moveToDelivered = document.getElementById('moveToDelivered');
  const moveToDelete = document.getElementById('moveToDelete');
  const closeMove = document.getElementById('closeMove');

  const paymentModal = document.getElementById('paymentModal');
  const payAmount = document.getElementById('payAmount');
  const payMethod = document.getElementById('payMethod');
  const payDate = document.getElementById('payDate');
  const submitPayment = document.getElementById('submitPayment');
  const cancelPayment = document.getElementById('cancelPayment');

  const photoModal = document.getElementById('photoModal');
  const mainGrid = document.getElementById('mainGrid');
  const measGrid = document.getElementById('measGrid');
  const photoTitle = document.getElementById('photoTitle');
  const closePhoto = document.getElementById('closePhoto');
  const createMergeBtn = document.getElementById('createMergeBtn');

  const shareModal = document.getElementById('shareModal');
  const shareText = document.getElementById('shareText');
  const copyShare = document.getElementById('copyShare');
  const closeShare = document.getElementById('closeShare');

  // state
  let currentUser = null;
  let bills = [];
  let selectedBill = null;
  let selectedBillId = null;
  const params = new URLSearchParams(window.location.search);
  const sectionType = params.get('type') || 'Booked'; // Booked | Ready | Delivered

  // restore session (expects localStorage.supabaseUser)
  function restoreSession(){
    try {
      const s = localStorage.getItem('supabaseUser');
      if (!s) return false;
      currentUser = JSON.parse(s);
      return true;
    } catch(e){
      return false;
    }
  }

  // parse status_info safely
  function parseStatusInfo(b){
    let si = b.status_info || {};
    if (typeof si === 'string'){
      try { si = JSON.parse(si) } catch(e){ si = {} }
    }
    return si || {};
  }

  function shortCodeFor(status){
    if (!status) return 'NO';
    if (status === 'Alter') return 'LT';
    if (status === 'Order') return 'OD';
    if (status === 'Ready') return 'RD';
    return 'NO';
  }
  function shortClassFor(status){
    if (status === 'Alter') return 'short-LT';
    if (status === 'Order') return 'short-OD';
    if (status === 'Ready') return 'short-RD';
    return 'short-NO';
  }

  // load bills
  async function loadBills(){
    try {
      if (!restoreSession()){ statusNote.textContent = 'No local session. Please login via index.'; return; }
      statusNote.textContent = 'Loading bills…';
      const uid = currentUser.id || (currentUser.user && currentUser.user.id) || currentUser;
      const { data, error } = await supabase.from('bills').select('*').eq('user_id', uid).eq('status', sectionType).order('id', { ascending: false });
      if (error){ console.error('loadBills error', error); bills = []; renderBills(); statusNote.textContent = 'Failed to load bills'; return; }
      bills = data || [];
      statusNote.textContent = `${bills.length} bills in ${sectionType}`;
      renderBills();
      // if focus param present, open that bill
      const focus = params.get('focus');
      const action = params.get('action');
      if (focus) {
        const id = Number(focus);
        setTimeout(()=> {
          if (action === 'move') openMoveModal(id)
          else openPhotoModal(id)
        }, 400);
      }
    } catch(err){ console.error('loadBills ex', err); statusNote.textContent = 'Error loading bills'; }
  }

  // render bills
  function renderBills(){
    const q = (searchInput.value || '').trim().toLowerCase();
    let arr = bills.slice();
    if (q){
      arr = arr.filter(b=>{
        const bn = (b.bill_no||'').toString();
        const dates = `${b.delivery_date||''} ${b.delivered_date||''}`.toLowerCase();
        return bn.includes(q) || dates.includes(q);
      });
    }
    const s = sortSelect.value;
    arr.sort((a,b)=>{
      if (s === 'bill-asc') return (a.bill_no||0)-(b.bill_no||0);
      if (s === 'bill-desc') return (b.bill_no||0)-(a.bill_no||0);
      const da = (a.status === 'Delivered' ? a.delivered_date : a.delivery_date) || '';
      const db = (b.status === 'Delivered' ? b.delivered_date : b.delivery_date) || '';
      if (s === 'date-asc') return new Date(da) - new Date(db);
      if (s === 'date-desc') return new Date(db) - new Date(da);
      return 0;
    });

    billList.innerHTML = '';
    if (!arr.length){ billList.innerHTML = `<div class="muted" style="padding:20px;text-align:center">No bills found</div>`; return; }

    arr.forEach(b=>{
      const li = document.createElement('li'); li.className = 'card';

      const left = document.createElement('div'); left.className = 'leftCol';
      const top = document.createElement('div'); top.className = 'billRow';
      const billNo = document.createElement('div'); billNo.className = 'billNo'; billNo.textContent = `#${b.bill_no}`;
      top.appendChild(billNo);

      if (sectionType === 'Booked'){
        const si = parseStatusInfo(b);
        const sc = document.createElement('div'); sc.className = `statusShort ${shortClassFor(si.status)}`; sc.textContent = shortCodeFor(si.status); sc.title = si.status || 'No Action';
        sc.addEventListener('click', ()=> openStatusModal(b));
        top.appendChild(sc);
      }

      left.appendChild(top);
      const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = (b.status === 'Delivered' ? `Delivered: ${b.delivered_date || '-'}` : `Delivery: ${b.delivery_date || '-'}`);
      left.appendChild(meta);

      const actions = document.createElement('div'); actions.className = 'actions';
      const viewBtn = document.createElement('button'); viewBtn.className = 'btn btnView'; viewBtn.textContent = 'View';
      viewBtn.addEventListener('click', ()=> openPhotoModal(b.id));
      const moveBtn = document.createElement('button'); moveBtn.className = 'btn btnMove'; moveBtn.textContent = 'Move';
      moveBtn.addEventListener('click', ()=> openMoveModal(b.id));
      actions.appendChild(viewBtn); actions.appendChild(moveBtn);

      if (sectionType === 'Delivered'){
        const copyBtn = document.createElement('button'); copyBtn.className = 'btn btnCopy'; copyBtn.textContent = 'Copy';
        copyBtn.addEventListener('click', ()=> copyDelivered(b));
        actions.appendChild(copyBtn);
      }

      li.appendChild(left); li.appendChild(actions);
      billList.appendChild(li);
    });
  }

  // ----- STATUS modal handlers -----
  let selectedStatusBill = null;
  function openStatusModal(bill){
    selectedStatusBill = bill;
    statusHeading.textContent = `Bill #${bill.bill_no} — Status`;
    const si = parseStatusInfo(bill);
    actionSelect.value = si.status || 'No Action';
    notesInput.value = si.note || '';
    statusModal.classList.add('show'); statusModal.removeAttribute('aria-hidden');
  }
  saveStatusBtn.addEventListener('click', async ()=>{
    if (!selectedStatusBill) return;
    const newStatus = actionSelect.value;
    const note = notesInput.value;
    try {
      const { data } = await supabase.from('bills').select('status_info').eq('id', selectedStatusBill.id).single();
      let si = data?.status_info || {};
      if (typeof si === 'string'){ try{ si = JSON.parse(si) }catch{} }
      si = Object.assign({}, si, { status: newStatus, note });
      const { error } = await supabase.from('bills').update({ status_info: si }).eq('id', selectedStatusBill.id);
      if (error) throw error;
      statusModal.classList.remove('show');
      await loadBills();
    } catch(e){ console.error('saveStatus err', e); alert('Save failed') }
  });
  closeStatusBtn.addEventListener('click', ()=> statusModal.classList.remove('show'));

  // autosave notes
  let notesTimer = null;
  notesInput.addEventListener('input', ()=>{
    clearTimeout(notesTimer);
    autoSaveMsg.textContent = 'Saving...';
    notesTimer = setTimeout(async ()=>{
      if (!selectedStatusBill) { autoSaveMsg.textContent = 'No bill selected'; return; }
      try {
        const { data } = await supabase.from('bills').select('status_info').eq('id', selectedStatusBill.id).single();
        let si = data?.status_info || {};
        if (typeof si === 'string'){ try{ si = JSON.parse(si) }catch{} }
        si = Object.assign({}, si, { note: notesInput.value });
        await supabase.from('bills').update({ status_info: si }).eq('id', selectedStatusBill.id);
        autoSaveMsg.textContent = 'Notes saved';
        setTimeout(()=> autoSaveMsg.textContent = 'Notes autosave after pause.', 900);
      } catch(e){ console.error('autosave err', e); autoSaveMsg.textContent = 'Save failed' }
    }, 900);
  });

  // ----- PHOTO modal handlers -----
  async function openPhotoModal(billId){
    try {
      const { data: bill, error } = await supabase.from('bills').select('*').eq('id', billId).single();
      if (error || !bill){ alert('Cannot load bill'); console.error(error); return; }
      selectedBill = bill; selectedBillId = billId;
      photoTitle.textContent = `Bill #${bill.bill_no} — Photos`;
      const mainImgs = Array.isArray(bill.main_images) ? bill.main_images : (bill.main_images ? JSON.parse(bill.main_images) : []);
      const measImgs = Array.isArray(bill.measurement_images) ? bill.measurement_images : (bill.measurement_images ? JSON.parse(bill.measurement_images) : []);
      mainGrid.innerHTML = ''; measGrid.innerHTML = '';
      if (!mainImgs.length) mainGrid.innerHTML = '<div class="muted">No main images uploaded</div>';
      if (!measImgs.length) measGrid.innerHTML = '<div class="muted">No measurement images uploaded</div>';
      mainImgs.forEach(url=>{
        const wrap = document.createElement('div'); wrap.className='photo-wrap';
        // include radio select for use in merge, download button and preview image
        wrap.innerHTML = `<img src="${url}" alt="main"/><button class="download-btn" onclick="downloadImage('${url}')">⬇</button><div style="text-align:center;margin-top:6px"><label style="font-size:12px"><input type="radio" name="mainSelect" value="${url}"/> Select</label></div>`;
        mainGrid.appendChild(wrap);
      });
      measImgs.forEach(url=>{
        const wrap = document.createElement('div'); wrap.className='photo-wrap';
        wrap.innerHTML = `<img src="${url}" alt="meas"/><button class="download-btn" onclick="downloadImage('${url}')">⬇</button><div style="text-align:center;margin-top:6px"><label style="font-size:12px"><input type="radio" name="measSelect" value="${url}"/> Select</label></div>`;
        measGrid.appendChild(wrap);
      });
      photoModal.classList.add('show'); photoModal.removeAttribute('aria-hidden');
    } catch (err){ console.error('openPhotoModal err', err); alert('Error loading photos') }
  }
  window.openPhotoModal = openPhotoModal;
  window.downloadImage = (url) => {
    try {
      const a = document.createElement('a'); a.href = url; a.download = 'image'; document.body.appendChild(a); a.click(); a.remove();
    } catch (err) { console.error('download error', err) }
  }
  closePhoto.addEventListener('click', ()=> photoModal.classList.remove('show'));

  // Merge: use selected radio values
  createMergeBtn.addEventListener('click', async ()=>{
    try {
      const mainUrl = document.querySelector('input[name="mainSelect"]:checked')?.value;
      const measUrl = document.querySelector('input[name="measSelect"]:checked')?.value;
      if (!mainUrl || !measUrl) return alert('Select one main and one measurement image (choose radios).');
      const [mainImg, measImg] = await Promise.all([ loadImg(mainUrl), loadImg(measUrl) ]);
      const canvasW = 1600, canvasH = 1000;
      const canvas = document.createElement('canvas'); canvas.width = canvasW; canvas.height = canvasH;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvasW,canvasH);
      const leftW = Math.round(canvasW * 0.40), rightW = canvasW - leftW;
      drawContain(ctx, measImg, 0, 0, leftW, canvasH);
      drawCover(ctx, mainImg, leftW, 0, rightW, canvasH);
      function strokeFillText(text,x,y,font,align='center'){ ctx.font=font; ctx.textAlign=align; ctx.lineWidth = Math.max(3,Math.round(canvasW/800)); ctx.strokeStyle='#000'; ctx.fillStyle='#fff'; ctx.strokeText(text,x,y); ctx.fillText(text,x,y); }
      strokeFillText('Royal Sherwani', canvasW/2, 56, 'bold 34px sans-serif');
      const dateText = formatDDMMYYYY(selectedBill?.delivery_date || selectedBill?.delivered_date || '');
      if (dateText) strokeFillText(dateText, leftW/2, 56, 'bold 24px sans-serif');
      const uid = currentUser?.email || currentUser?.id || '';
      if (uid) { ctx.font='bold 18px sans-serif'; ctx.textAlign='right'; ctx.lineWidth=5; ctx.strokeStyle='#000'; ctx.fillStyle='#fff'; ctx.strokeText(uid,canvasW-12,38); ctx.fillText(uid,canvasW-12,38); }
      const billNumber = (selectedBill?.bill_no||'').toString().replace(/[^0-9]/g,'') || (selectedBill?.bill_no||'');
      if (billNumber) { let fontSize=120; do{ ctx.font=`bold ${fontSize}px sans-serif`; const m = ctx.measureText(billNumber); if (m.width <= rightW*0.9) break; fontSize -= 10 }while(fontSize>30); strokeFillText(billNumber, leftW + Math.round(rightW/2), canvasH/2 + 30, `bold ${fontSize}px sans-serif`); }
      const now = new Date(); const pad = n => String(n).padStart(2,'0'); const dd=pad(now.getDate()), mm=pad(now.getMonth()+1), yyyy=now.getFullYear(), hh=pad(now.getHours()), min=pad(now.getMinutes()), ss=pad(now.getSeconds());
      const filename = `${selectedBill?.bill_no || 'bill'}-${dd}-${mm}-${yyyy}-${hh}-${min}-${ss}.png`;
      const link = document.createElement('a'); link.download = filename; link.href = canvas.toDataURL('image/png'); document.body.appendChild(link); link.click(); link.remove();
      alert('Merged image downloaded: ' + filename);
    } catch(err){ console.error('merge err', err); alert('Merge failed: '+(err.message||err)) }
  });

  // image helpers
  function loadImg(url){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=(e)=>rej(e); i.src=url }) }
  function drawCover(ctx,img,x,y,w,h){ const iw=img.width, ih=img.height, scale=Math.max(w/iw,h/ih), sw=w/scale, sh=h/scale, sx=Math.max(0,(iw-sw)/2), sy=Math.max(0,(ih-sh)/2); ctx.drawImage(img,sx,sy,sw,sh,x,y,w,h) }
  function drawContain(ctx,img,x,y,w,h){ const iw=img.width, ih=img.height, scale=Math.min(w/iw,h/ih), dw=Math.round(iw*scale), dh=Math.round(ih*scale), dx=x+Math.round((w-dw)/2), dy=y+Math.round((h-dh)/2); ctx.fillStyle='#fff'; ctx.fillRect(x,y,w,h); ctx.drawImage(img,0,0,iw,ih,dx,dy,dw,dh) }
  function formatDDMMYYYY(dStr){ if(!dStr) return ''; const d=new Date(dStr); if(isNaN(d)) return dStr; const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()}` }

  // ----- MOVE modal handlers (fully wired) -----
  let activeMoveBillId = null;
  function openMoveModal(billId){
    activeMoveBillId = billId;
    moveModal.classList.add('show');
  }
  moveToBooked.addEventListener('click', async ()=> { await performMove(activeMoveBillId,'Booked'); })
  moveToReady.addEventListener('click', async ()=> { await performMove(activeMoveBillId,'Ready'); })
  moveToDelivered.addEventListener('click', async ()=> { moveModal.classList.remove('show'); openPaymentModal(activeMoveBillId); })
  moveToDelete.addEventListener('click', async ()=> {
    if (!confirm('Delete this bill?')) return;
    moveModal.classList.remove('show');
    try { const { error } = await supabase.from('bills').delete().eq('id', activeMoveBillId); if (error) throw error; alert('Deleted'); await loadBills(); } catch(e){ alert('Delete failed'); console.error(e) }
  })
  closeMove.addEventListener('click', ()=> moveModal.classList.remove('show'));

  async function performMove(billId, dest){
    try {
      // if moving out of Booked -> clear status_info
      const { data:bill } = await supabase.from('bills').select('status').eq('id', billId).single();
      if (bill && bill.status === 'Booked' && (dest === 'Ready' || dest === 'Delivered')) {
        await supabase.from('bills').update({ status_info: {} }).eq('id', billId);
      }
      const { error } = await supabase.from('bills').update({ status: dest }).eq('id', billId);
      if (error) throw error;
      moveModal.classList.remove('show');
      await loadBills();
      alert('Moved to '+dest);
    } catch(e){ console.error('performMove', e); alert('Move failed') }
  }

  // payment flow
  function openPaymentModal(billId){
    activeMoveBillId = billId;
    payDate.value = new Date().toISOString().slice(0,10);
    paymentModal.classList.add('show');
  }
  cancelPayment.addEventListener('click', ()=> paymentModal.classList.remove('show'));
  submitPayment.addEventListener('click', async ()=>{
    const amt = payAmount.value.trim(); const method = payMethod.value; const ddate = payDate.value || new Date().toISOString().slice(0,10);
    if (!amt) return alert('Enter amount');
    try {
      const { error } = await supabase.from('bills').update({ status:'Delivered', amount: amt, method, delivered_date: ddate }).eq('id', activeMoveBillId);
      if (error) throw error;
      paymentModal.classList.remove('show');
      await loadBills();
      const { data } = await supabase.from('bills').select('*').eq('id', activeMoveBillId).single();
      const text = `Bill No: ${data.bill_no}\nAmount: ${data.amount}\nPayment: ${data.method}\nDelivered Date: ${data.delivered_date}`;
      shareText.textContent = text; shareModal.classList.add('show');
      try { await navigator.clipboard.writeText(text); } catch {}
    } catch(e){ console.error('submitPayment err',e); alert('Payment update failed') }
  });

  copyShare.addEventListener('click', async ()=> { try { await navigator.clipboard.writeText(shareText.textContent); alert('Copied'); } catch(e){ alert('Copy failed') } })
  closeShare.addEventListener('click', ()=> shareModal.classList.remove('show'));

  // copy delivered details quick (from list)
  function copyDelivered(bill){
    const text = `Bill No: ${bill.bill_no}\nAmount: ${bill.amount||''}\nPayment: ${bill.method||''}\nDelivered Date: ${bill.delivered_date||bill.delivery_date||''}`;
    try { navigator.clipboard.writeText(text); alert('Copied'); } catch(e){ alert('Copy failed') }
  }

  // events
  searchInput.addEventListener('input', renderBills);
  sortSelect.addEventListener('change', renderBills);
  logoutBtn.addEventListener('click', async ()=>{ try{ await supabase.auth.signOut() }catch{}; localStorage.removeItem('supabaseUser'); window.location.href='index.html' });

  // init
  loadBills();

  // expose for debug if needed
  window.openMoveModal = openMoveModal;
  window.openPhotoModal = openPhotoModal;
  window._section = { loadBills, supabase };
</script>
</body>
</html>